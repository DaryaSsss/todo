<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: TodoCard.jsx</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: TodoCard.jsx</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import dayjs from 'dayjs';
import {
  useFirestoreDocumentDeletion,
  useFirestoreDocumentMutation,
} from '@react-query-firebase/firestore';
import { collection, doc } from 'firebase/firestore';
import { useState, useEffect } from 'react';
import { isDayExpired } from '../helpers';
import { firestore, storage } from '../firebase';
import { ref, getDownloadURL, listAll, deleteObject,uploadBytes } from "firebase/storage";
import { IconX } from '@tabler/icons';

/** @module component for one todo with functions to delete and update todo, delete, update and add filess */

const TodoCard = ({ data, id }) => { 
  const [type, setType] = useState('view');
  const [name, setName] = useState(data.name);
  const [desc, setDesc] = useState(data.desc);
  const [date, setDate] = useState(data.date);
  const [isDone, setIsDone] = useState(data.isDone);
  const [files, setFiles] = useState([])
  const [uploadedFile, setUploadedFile] = useState([])
  const [refetchFiles, setRefetchFiles] = useState(true)

  const deleteFrom = collection(firestore, 'todos');
  const refDelete = doc(deleteFrom, id);
  const mutationDeleteTodo = useFirestoreDocumentDeletion(refDelete);

  const updateWhere = collection(firestore, 'todos');
  const refUpdate = doc(updateWhere, id);
  const mutationUpdateTodo = useFirestoreDocumentMutation(refUpdate);

  useEffect(() => { console.log(files) }, [files])

  /** @method function to delete todo with all todo files */
  const handleDelete = () => {
    mutationDeleteTodo.mutate()
    files.map((file) => {
      handleFileDelete(file.children)
    })
  }

  /** @method function to update todo info (besides info about its completion) */
  const handleTodo = async e => {
    e.preventDefault();
    onFileUpload()
    await mutationUpdateTodo.mutate({
      isDone,
      name,
      desc,
      date,
      fileId: data.fileId,
    });
    setType('view');
    setUploadedFile([])
  };

  /** 
   * @method function to get files for every todo 
   * @returns { any[] } - return array of all files by setting them in files (useState - setFiles)
  */
  useEffect(() => {
    const getFiles = async () => {
      const returnList = []
      const listRef = ref(storage, data.fileId);
      const response = await listAll(listRef)
      for (const itemRef of response.items) {
        const url = await getDownloadURL(itemRef)
        returnList.push({ children: itemRef.name, href: url })
      }
      setFiles(returnList)
    }
    getFiles()
  }, [])

  /** 
   * @method function to delete file from storage 
   * @param { any } fileName - name of file to delete
  */
  const handleFileDelete = async (fileName) => {
    const fileRef = ref(storage, `${data.fileId}/${fileName}`);
    await deleteObject(fileRef);
    setFiles(prev => prev.filter(file => file.children !== fileName))
  }

  /** @method function to upload files to storage */
  const onFileUpload = async () => {
  if (uploadedFile === null) return;


    for (const file of Array.from(uploadedFile)) {
      const fileRef = ref(storage, `/${data.fileId}/${file.name}`)
      await uploadBytes(fileRef, file)
      const newFile = { children: file.name, href: await getDownloadURL(fileRef) }
      setFiles(prev => [...prev, newFile])
    } 
  }

   /** @method function to update info about todo completion (checkbox) */
  const updateIsDone = () => {
    const newIsDone = !isDone
    setIsDone(newIsDone)
    mutationUpdateTodo.mutate({
      isDone: newIsDone,
      name: data.name,
      desc: data.desc,
      date: data.date,
      fileId: data.fileId,
    });
  }


  return (
    &lt;div>
      {type === 'view' ? (
        &lt;div className="Card">
          &lt;div className="Info">
            &lt;div className="CardHeader">
              &lt;input
                type="checkbox"
                checked={isDone}
                onChange={updateIsDone}
              />
              &lt;p className={!isDone ? 'Name' : 'Name Done'}>{data.name}&lt;/p>
              &lt;p className={!isDayExpired(data.date) ? 'Date' : 'Date Expired'}>
                {dayjs(data.date).format('DD/MM/YYYY')}
              &lt;/p>
            &lt;/div>
            &lt;p className="Desc">{data.desc}&lt;/p>
            &lt;div className='Files'>
              {files.map(f => &lt;a {...f} target="_blank" key={f.href}/>)}
            &lt;/div>
          &lt;/div>
          &lt;div className="Actions">
            &lt;button
              type="button"
              className="Delete"
              disabled={mutationDeleteTodo.isLoading}
              onClick={handleDelete}
            >
              Delete
            &lt;/button>
            &lt;button
              type="button"
              onClick={() => {
                setType('edit');
              }}
            >
              Edit
            &lt;/button>
          &lt;/div>
        &lt;/div>
      ) : (
        &lt;form onSubmit={handleTodo}>
          &lt;div className="Card">
            &lt;div className="Info">
              &lt;div className="CardHeader">
                &lt;input
                  type="text"
                  maxLength={32}
                  value={name}
                  placeholder="Title"
                  onChange={e => setName(e.currentTarget.value)}
                  required
                />
                &lt;input
                  type="date"
                  value={date}
                  placeholder="Date"
                  onChange={e => setDate(e.currentTarget.value)}
                  required
                />
              &lt;/div>
              &lt;textarea
                rows={5}
                value={desc}
                placeholder="Description"
                onChange={e => setDesc(e.currentTarget.value)}
                required
              />
            &lt;input type="file" multiple onChange={(e) => setUploadedFile(e.target.files)} />
            &lt;div className='Files'>
              {files.map(f => &lt;div className='FileDelete' key={f.href}>&lt;a {...f} target="_blank" />&lt;button type="button" className='DeleteIcon' onClick={() => handleFileDelete(f.children)}>&lt;IconX />&lt;/button>&lt;/div>)}
            &lt;/div>
            &lt;/div>
            &lt;div className="Actions">
              &lt;button type="submit" className="Save">
                Save
              &lt;/button>
              &lt;button
                type="button"
                onClick={() => {
                  setType('view');
                }}
              >
                Close
              &lt;/button>
            &lt;/div>
          &lt;/div>
        &lt;/form>
      )}
    &lt;/div>
  );
};
export default TodoCard;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="component%2520for%2520one%2520todo%2520with%2520functions%2520to%2520delete%2520and%2520update%2520todo,%2520delete,module_%2520update%2520and%2520add%2520filess.html"> update and add filess</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.0</a> on Mon Nov 28 2022 19:48:56 GMT+0300 (Москва, стандартное время)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
